name: Release

on:
  release:
    types: [published]

jobs:
  publish-to-pypi:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Extract and validate version from tag
      id: version
      run: |
        # Remove 'v' prefix if present (e.g., v1.2.3 -> 1.2.3)
        VERSION="${GITHUB_REF#refs/tags/v}"
        VERSION="${VERSION#refs/tags/}"

        # Validate version format (semantic versioning: X.Y.Z)
        if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$'; then
          echo "Error: Invalid version format: $VERSION"
          echo "Expected format: X.Y.Z or X.Y.Z-pre or X.Y.Z+build"
          exit 1
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "✓ Extracted and validated version: $VERSION"

    - name: Update version in pyproject.toml
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        python3 << EOF
        import re
        import sys
        import os

        VERSION = os.environ['VERSION']
        with open('pyproject.toml', 'r') as f:
            content = f.read()

        # Update version line (handles both quoted and unquoted)
        pattern = r'^version\s*=\s*["\']?[^"\']+["\']?'
        replacement = f'version = "{VERSION}"'
        new_content = re.sub(pattern, replacement, content, flags=re.MULTILINE)

        if new_content == content:
            print("Error: Could not find version line in pyproject.toml")
            sys.exit(1)

        with open('pyproject.toml', 'w') as f:
            f.write(new_content)

        # Verify the update
        with open('pyproject.toml', 'r') as f:
            if f'version = "{VERSION}"' not in f.read():
                print(f"Error: Failed to update version to {VERSION}")
                sys.exit(1)

        print(f"✓ Updated pyproject.toml version to {VERSION}")
        EOF
      env:
        VERSION: ${{ steps.version.outputs.version }}

    - name: Update version in setup.py
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        python3 << EOF
        import re
        import sys
        import os

        VERSION = os.environ['VERSION']
        with open('setup.py', 'r') as f:
            content = f.read()

        # Update version in setup() call
        pattern = r'version\s*=\s*["\'][^"\']+["\']'
        replacement = f'version="{VERSION}"'
        new_content = re.sub(pattern, replacement, content)

        if new_content == content:
            print("Error: Could not find version in setup.py")
            sys.exit(1)

        with open('setup.py', 'w') as f:
            f.write(new_content)

        # Verify the update
        with open('setup.py', 'r') as f:
            if f'version="{VERSION}"' not in f.read():
                print(f"Error: Failed to update version to {VERSION}")
                sys.exit(1)

        print(f"✓ Updated setup.py version to {VERSION}")
        EOF
      env:
        VERSION: ${{ steps.version.outputs.version }}

    - name: Verify version consistency
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        python3 << EOF
        import re
        import sys
        import os

        VERSION = os.environ['VERSION']
        # Check pyproject.toml
        with open('pyproject.toml', 'r') as f:
            pyproject_content = f.read()
            pyproject_match = re.search(r'version\s*=\s*["\']([^"\']+)["\']', pyproject_content)
            if not pyproject_match or pyproject_match.group(1) != VERSION:
                print(f"Error: pyproject.toml version mismatch. Expected: {VERSION}, Found: {pyproject_match.group(1) if pyproject_match else 'None'}")
                sys.exit(1)

        # Check setup.py
        with open('setup.py', 'r') as f:
            setup_content = f.read()
            setup_match = re.search(r'version\s*=\s*["\']([^"\']+)["\']', setup_content)
            if not setup_match or setup_match.group(1) != VERSION:
                print(f"Error: setup.py version mismatch. Expected: {VERSION}, Found: {setup_match.group(1) if setup_match else 'None'}")
                sys.exit(1)

        print(f"✓ Version consistency verified: {pyproject_match.group(1)} == {setup_match.group(1)} == {VERSION}")
        EOF
      env:
        VERSION: ${{ steps.version.outputs.version }}

    - name: Check if version already exists on PyPI
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        PACKAGE_NAME="webtop-il-kit"
        python3 << EOF
        import urllib.request
        import json
        import sys
        import os

        VERSION = os.environ['VERSION']
        PACKAGE_NAME = os.environ['PACKAGE_NAME']
        try:
            url = f"https://pypi.org/pypi/{PACKAGE_NAME}/{VERSION}/json"
            with urllib.request.urlopen(url) as response:
                data = json.loads(response.read())
                print(f"⚠️  Warning: Version {VERSION} already exists on PyPI!")
                print(f"   URL: https://pypi.org/project/{PACKAGE_NAME}/{VERSION}/")
                print("   This will cause a publishing failure.")
                sys.exit(1)
        except urllib.error.HTTPError as e:
            if e.code == 404:
                print(f"✓ Version {VERSION} is not on PyPI, safe to publish")
            else:
                print(f"⚠️  Could not check PyPI (HTTP {e.code}), proceeding anyway")
        except Exception as e:
            print(f"⚠️  Could not check PyPI ({type(e).__name__}), proceeding anyway")
        EOF
      env:
        VERSION: ${{ steps.version.outputs.version }}
        PACKAGE_NAME: webtop-il-kit
      continue-on-error: true

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build

    - name: Build package
      run: |
        python -m build

    - name: Verify built package version
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        python3 << EOF
        import tarfile
        import re
        import sys
        import glob
        import os

        VERSION = os.environ['VERSION']
        # Check wheel file
        wheels = glob.glob('dist/*.whl')
        if wheels:
            wheel_name = wheels[0]
            if f"-{VERSION}-" not in wheel_name:
                print(f"Error: Wheel version mismatch. Expected {VERSION} in {wheel_name}")
                sys.exit(1)
            print(f"✓ Wheel version verified: {wheel_name}")

        # Check source distribution
        sdists = glob.glob('dist/*.tar.gz')
        if sdists:
            sdist_name = sdists[0]
            if f"-{VERSION}.tar.gz" not in sdist_name:
                print(f"Error: Source distribution version mismatch. Expected {VERSION} in {sdist_name}")
                sys.exit(1)
            print(f"✓ Source distribution version verified: {sdist_name}")

        print(f"✓ All built packages have correct version: {VERSION}")
        EOF
      env:
        VERSION: ${{ steps.version.outputs.version }}

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
